# Dockerfile for OpenCode Sandbox Container
# Extends Cloudflare Sandbox base image with OpenCode CLI
FROM docker.io/cloudflare/sandbox:0.4.14

# Install OpenCode CLI globally (like other system tools)
RUN npm install -g opencode-ai

# Install Hono and dependencies for the container worker
RUN npm install -g hono@4.8.2 zod@3.25.76

# Copy container worker files and dependencies
COPY src/worker/container-worker.ts /opt/worker/container-worker.ts
COPY src/worker/opencode-app.ts /opt/worker/opencode-app.ts
COPY src/worker/utils /opt/worker/utils
COPY src/types /opt/types
COPY src/lib /opt/lib

ENV NODE_EXTRA_CA_CERTS="/etc/ssl/certs/Cloudflare_CA.pem"

# Install warp certs as root if script exists (optional for internal users)
COPY src/internal-scripts /tmp/internal-scripts
RUN if [ -f /tmp/internal-scripts/install-cloudflare-warp-certs.sh ]; then \
    chmod +x /tmp/internal-scripts/install-cloudflare-warp-certs.sh && \
    /tmp/internal-scripts/install-cloudflare-warp-certs.sh; \
  else \
    echo "Skipping Cloudflare WARP certs installation (script not found)"; \
  fi && rm -rf /tmp/internal-scripts

# Expose ports for OpenCode server (4096) and container worker (8080)
EXPOSE 4096 8080
